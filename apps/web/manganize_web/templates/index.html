{% extends "base.html" %}

{% block title %}Manganize - マンガ画像生成{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <p class="text-center mb-8" style="color: var(--xp-text-secondary); font-family: var(--xp-font-family); font-size: 14px;">
        トピックを入力してマンガ画像を生成します
    </p>

    <!-- Generation Form -->
    <div class="card mb-6" x-data="generationForm()">
        <form id="generation-form"
              hx-post="/api/generate"
              hx-target="#content-area"
              hx-swap="innerHTML"
              @htmx:before-request.self="isGenerating = true"
              @reset-generation.window="isGenerating = false">
            <input type="hidden" name="upload_id" x-model="uploadId">

            <!-- Character selection -->
            <div class="mb-4">
                <label for="character" class="block text-sm font-medium text-gray-700 mb-2">
                    キャラクター
                    <span class="spinner-sm htmx-indicator" hx-indicator></span>
                </label>
                <select id="character"
                        name="character"
                        class="input-field"
                        required
                        hx-get="/api/characters"
                        hx-trigger="load"
                        hx-swap="none"
                        hx-indicator=".htmx-indicator">
                    <option value="kurage">くらげちゃん (デフォルト)</option>
                </select>
            </div>

            <!-- Topic input -->
            <div class="mb-4">
                <label for="topic" class="block text-sm font-medium text-gray-700 mb-2">
                    トピック
                </label>

                <!-- File upload drop zone -->
                <div class="mb-3 border-2 border-dashed rounded-lg p-6 text-center transition-all duration-200"
                     :class="{
                         'border-blue-500 bg-blue-50': isDragging,
                         'border-green-400 bg-green-50': uploadedFilename && !isUploading,
                         'border-gray-300': !isDragging && !uploadedFilename
                     }"
                     @dragover.prevent="isDragging = true"
                     @dragleave.prevent="isDragging = false"
                     @drop.prevent="handleDrop">
                    <input type="file"
                           id="file-input"
                           x-ref="fileInput"
                           accept=".txt,.pdf,.md,.markdown"
                           class="hidden"
                           @change="handleFileSelect">

                    <div x-show="!isUploading && !uploadedFilename">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <button type="button"
                                    @click="$refs.fileInput.click()"
                                    class="text-blue-600 hover:text-blue-500 font-medium">
                                ファイルを選択
                            </button>
                            またはドラッグ＆ドロップ
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            TXT, PDF, MD（最大10MB）
                        </p>
                    </div>

                    <div x-show="isUploading" class="py-2">
                        <div class="spinner mx-auto"></div>
                        <p class="text-sm text-gray-600 mt-2">アップロード中...</p>
                    </div>

                    <div x-show="uploadedFilename && !isUploading" class="py-3">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 text-left">
                                <p class="text-sm font-medium text-green-800">アップロード完了</p>
                                <p class="text-xs text-green-700 mt-0.5 truncate" x-text="uploadedFilename"></p>
                            </div>
                        </div>
                        <button type="button"
                                @click="clearFile"
                                class="mt-3 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            削除して再選択
                        </button>
                    </div>
                </div>

                <textarea id="topic"
                          name="topic"
                          rows="5"
                          class="textarea-field"
                          placeholder="マンガにしたいトピックを入力してください（例: Transformerアーキテクチャについて）"
                          minlength="1"
                          maxlength="50000"
                          x-model="topicText"></textarea>
                <p class="text-sm text-gray-500 mt-1">
                    テキストを入力するか、上記からファイルをアップロードしてください（両方指定も可能）
                </p>
            </div>

            <!-- Submit button -->
            <div class="flex justify-center">
                <button type="submit"
                        id="generate-btn"
                        class="btn-primary"
                        :disabled="!canGenerate">
                    生成する
                </button>
            </div>
        </form>
    </div>

    <!-- Content area for progress and results -->
    <div id="content-area">
        <!-- Progress or results will be loaded here via HTMX -->
    </div>
</div>

<!-- Image modal (for full-size view) -->
<div id="image-modal"
     x-data="{ open: false, imageId: '' }"
     x-show="open"
     @keydown.escape.window="open = false"
     @open-modal.window="open = true; imageId = $event.detail.imageId"
     x-cloak
     class="modal-overlay"
     style="display: none;"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">

    <!-- Backdrop -->
    <div class="modal-backdrop" @click="open = false"></div>

    <!-- Modal content -->
    <div class="modal-container">
        <div class="modal-content"
             @click.stop
             x-transition:enter="transition ease-out duration-300 delay-75"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">

            <!-- Close button -->
            <button @click="open = false" class="modal-close">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>

            <!-- Image -->
            <img :src="'/api/images/' + imageId"
                 alt="Generated manga"
                 class="w-full h-auto rounded-lg">
        </div>
    </div>
</div>

<script>
    // Generation form with file upload
    function generationForm() {
        return {
            topicText: '',
            uploadId: '',
            isDragging: false,
            isUploading: false,
            uploadedFilename: '',
            isGenerating: false,

            get canGenerate() {
                return (this.topicText.trim().length > 0 || this.uploadId.length > 0) && !this.isGenerating;
            },

            handleDrop(event) {
                this.isDragging = false;
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    this.uploadFile(files[0]);
                }
            },

            handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    this.uploadFile(files[0]);
                }
            },

            async uploadFile(file) {
                this.isUploading = true;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'アップロードに失敗しました');
                    }

                    const data = await response.json();
                    this.uploadId = data.upload_id;
                    this.uploadedFilename = data.filename;

                    window.showToast('ファイルをアップロードしました', 'success');
                } catch (error) {
                    window.showToast(error.message, 'error');
                    console.error('Upload error:', error);
                } finally {
                    this.isUploading = false;
                }
            },

            clearFile() {
                this.uploadedFilename = '';
                this.uploadId = '';
                document.getElementById('file-input').value = '';
            }
        };
    }

    // Open image modal using Alpine.js custom event
    function openImageModal(imageId) {
        window.dispatchEvent(new CustomEvent('open-modal', {
            detail: { imageId: imageId }
        }));
    }

    // Reset generation and clear content area
    function resetGeneration() {
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.innerHTML = '';
        }
    }

    // Load characters for dropdown
    document.getElementById('character').addEventListener('htmx:afterRequest', function(event) {
        try {
            const characters = JSON.parse(event.detail.xhr.responseText);
            const select = event.target;

            // Clear existing options
            select.innerHTML = '';

            // Add characters as options
            characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char.name;
                option.textContent = char.display_name + (char.nickname ? ` (${char.nickname})` : '');
                if (char.is_default) {
                    option.textContent += ' [デフォルト]';
                    option.selected = true;
                }
                select.appendChild(option);
            });
        } catch (e) {
            console.error('Failed to load characters:', e);
        }
    });
</script>
{% endblock %}
