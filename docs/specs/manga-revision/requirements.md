# マンガ修正機能 要件定義

## 概要

生成済みマンガ画像に対して、ユーザーが画像上の位置を指定し、自由な修正指示を与えて再生成できるようにする。
修正対象はセリフに限定せず、イラスト、構図、背景、表情なども含む。

## 用語定義

| 用語 | 定義 |
|------|------|
| リビジョン | 既存の生成画像を親として行う修正再生成 |
| ターゲット | 修正対象の位置指定。`point` または `box` |
| point | 正規化座標 `(x, y)` を中心とするピンポイント指定 |
| box | 正規化座標 `(x, y, w, h)` で指定する矩形領域 |
| edit instruction | ターゲットに紐づく自由修正指示 |
| expected_text | 文字修正時のみ任意で使う期待文字列 |

---

## 機能要件

### FR-1: 修正モード UI

#### FR-1.1: 修正モードへの遷移

**[Event-driven]**
ユーザーが生成結果画面で「修正する」を選択した場合、システムは修正モード UI を表示すること。

#### FR-1.2: ターゲット指定

**[Event-driven]**
ユーザーが画像をクリックした場合、システムは `point` ターゲットを作成すること。

**[Event-driven]**
ユーザーが画像上をドラッグした場合、システムは `box` ターゲットを作成すること。

**[State-driven]**
修正モード中、システムは既存ターゲットを視覚的にオーバーレイ表示すること。

### FR-2: 修正指示入力

#### FR-2.1: 自由指示

**[Ubiquitous]**
システムは各ターゲットに対して自由テキストの修正指示入力を提供すること。

**[State-driven]**
ターゲットに修正指示が未入力の状態のとき、システムはそのターゲットを未完了として表示すること。

#### FR-2.2: 任意メタ情報

**[Optional]**
ユーザーが修正タイプを指定することを選択した場合、システムは `text` / `illustration` / `layout` / `style` / `auto` を受け付けること。

**[Optional]**
ユーザーが文字修正を明示したい場合、システムは `expected_text` を受け付けること。

### FR-3: リビジョン生成

#### FR-3.1: リビジョン要求送信

**[Event-driven]**
ユーザーが修正実行を選択した場合、システムは親画像 ID と修正指示群をバックエンド API に送信すること。

**[State-driven]**
リビジョン生成処理が実行中の状態のとき、システムは修正実行ボタンを無効化すること。

#### FR-3.2: 進捗表示

**[Ubiquitous]**
システムはリビジョン生成処理の進捗をリアルタイム表示すること。

**[Event-driven]**
リビジョン生成が完了した場合、システムは新しい画像を表示すること。

**[Event-driven]**
リビジョン生成でエラーが発生した場合、システムはエラーメッセージと再試行導線を表示すること。

### FR-4: 履歴と系譜

#### FR-4.1: 親子関係保存

**[Event-driven]**
リビジョン生成が完了した場合、システムは親生成 ID と修正指示を履歴に保存すること。

#### FR-4.2: 履歴表示

**[Ubiquitous]**
システムは履歴上でリビジョン元画像との関係が判別できる情報を表示すること。

### FR-5: バリデーション

#### FR-5.1: ターゲット数制限

**[Ubiquitous]**
システムは 1 回の修正要求あたりターゲット数を上限 5 件に制限すること。

#### FR-5.2: 座標検証

**[Ubiquitous]**
システムは `point` / `box` の座標値が 0.0 以上 1.0 以下であることを検証すること。

**[Ubiquitous]**
システムは `box` の幅・高さが正の値であり、画像範囲を超えないことを検証すること。

#### FR-5.3: 指示検証

**[Ubiquitous]**
システムは修正指示が空文字でないことを検証すること。

---

## 非機能要件

### NFR-1: レイテンシ

**[Ubiquitous]**
リビジョン進捗更新は 1 秒以内にクライアントへ配信すること。

### NFR-2: 互換性

**[Ubiquitous]**
既存の通常生成フローを破壊せず、修正フローを追加できること。

### NFR-3: 可観測性

**[Ubiquitous]**
システムはリビジョン要求の親 ID、編集件数、失敗理由をログとして記録すること。

### NFR-4: 安全性

**[Ubiquitous]**
システムは過剰な入力を防ぐため、修正指示文字数と edit 件数に上限を設けること。
