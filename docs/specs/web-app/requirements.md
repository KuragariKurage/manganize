# Web アプリ 要件定義

## 概要

manganize のコアエージェント機能を Web アプリケーションとして提供する。
ユーザーがテキストコンテンツを入力またはアップロードし、マンガ画像を生成・閲覧できるようにする。

## 用語定義

| 用語 | 定義 |
|------|------|
| 生成リクエスト | ユーザーがトピックを入力し、マンガ画像生成を開始する操作 |
| 生成履歴 | 過去に生成されたマンガ画像とその入力トピックの記録 |
| 進捗状態 | 生成処理の現在の段階（リサーチ中、シナリオ作成中、画像生成中、完了） |
| キャラクター | マンガに登場するキャラクターの定義（名前、外見、性格等） |

---

## 機能要件

### FR-1: トピック入力

#### FR-1.1: テキストエリアによる直接入力

**[Ubiquitous]**
システムは、ユーザーがトピックを直接入力できるテキストエリアを提供すること。

**[State-driven]**
テキストエリアが空の状態のとき、システムは生成ボタンを無効化すること。

#### FR-1.2: ファイルアップロード

**[Optional]**
ユーザーがファイルをアップロードすることを選択した場合、システムは `.txt` / `.md` / `.markdown` / `.pdf` 形式を受け付けること。

**[Event-driven]**
ユーザーがファイルをドラッグ＆ドロップした場合、システムはファイルをオブジェクトストレージに保存し、`upload_id` を生成すること。

**[Event-driven]**
ユーザーが生成ボタンをクリックした場合、システムは `topic` または `upload_id` の少なくとも一方を送信すること。

**[Event-driven]**
ユーザーが対応していない形式のファイルをアップロードした場合、システムはエラーメッセージを表示すること。

---

### FR-2: キャラクターカスタマイズ

#### FR-2.1: キャラクター選択

**[Ubiquitous]**
システムは、生成時に使用するキャラクターを選択するドロップダウンを提供すること。

**[Ubiquitous]**
システムは、デフォルトキャラクター（くらげ）を提供すること。

#### FR-2.2: キャラクター一覧表示

**[Ubiquitous]**
システムは、登録されているキャラクターの一覧を表示する画面を提供すること。

**[Ubiquitous]**
キャラクター一覧には、名前と参照画像（存在する場合）を表示すること。

#### FR-2.3: キャラクター作成

**[Optional]**
ユーザーが新規キャラクターを作成することを選択した場合、システムはキャラクター作成フォームを表示すること。

**[Ubiquitous]**
キャラクター作成フォームは以下の項目を含むこと：
- 名前（必須）
- 説明（必須）
- 外見の特徴（必須）
- 性格・口調（必須）
- 参照画像（オプション）

**[Event-driven]**
ユーザーがキャラクターを保存した場合、システムはキャラクターをデータベースに保存し、一覧を更新すること。

#### FR-2.4: キャラクター編集

**[Event-driven]**
ユーザーが既存のキャラクターを選択した場合、システムはキャラクター編集フォームを表示すること。

**[Event-driven]**
ユーザーがキャラクターを更新した場合、システムはデータベースを更新し、変更を反映すること。

#### FR-2.5: キャラクター削除

**[Optional]**
ユーザーがキャラクターを削除することを選択した場合、システムは確認ダイアログを表示した後、該当するキャラクターを削除すること。

**[State-driven]**
デフォルトキャラクター（くらげ）が選択されている状態のとき、システムは削除ボタンを無効化すること。

---

### FR-3: マンガ画像生成

#### FR-3.1: 生成リクエストの送信

**[Event-driven]**
ユーザーが生成ボタンをクリックした場合、システムはトピック・`upload_id`・キャラクター情報をバックエンド API に送信し、マンガ画像生成処理を開始すること。

**[Event-driven]**
`upload_id` が指定された場合、システムはバックエンドで短命な署名付き URL を発行し、エージェントがファイルを自律的に読み取れる形で処理すること。

**[State-driven]**
生成処理が実行中の状態のとき、システムは生成ボタンを無効化すること。

#### FR-3.2: 進捗状態の表示

**[Ubiquitous]**
システムは、生成処理の進捗状態をリアルタイムでユーザーに表示すること。

**[State-driven]**
各進捗状態において、システムは以下の情報を表示すること：
- `researching`: 「リサーチ中...」
- `writing_scenario`: 「シナリオ作成中...」
- `generating_image`: 「画像生成中...」
- `completed`: 生成された画像

**[Event-driven]**
生成処理でエラーが発生した場合、システムはエラーメッセージを表示し、再試行オプションを提供すること。

#### FR-3.3: 生成結果の表示

**[Event-driven]**
生成処理が完了した場合、システムは生成されたマンガ画像を画面に表示すること。

---

### FR-4: 画像表示・ダウンロード

#### FR-4.1: 画像表示

**[Ubiquitous]**
システムは、生成されたマンガ画像を適切なサイズで画面に表示すること。

**[Optional]**
ユーザーが画像をクリックした場合、システムはフルサイズの画像を表示すること。

#### FR-4.2: タイトル生成

**[Ubiquitous]**
システムは、トピックから 3-5 単語の短いタイトルを自動生成すること。

**[Event-driven]**
タイトル生成に失敗した場合、システムはフォールバックとして日時のみをファイル名として使用すること。

#### FR-4.3: 画像ダウンロード

**[Optional]**
ユーザーが画像をダウンロードすることを選択した場合、システムは PNG 形式で画像をダウンロードできるようにすること。

**[Ubiquitous]**
ダウンロードファイル名は `manganize_{日時}_{短いタイトル}.png` 形式であること。

---

### FR-5: 生成履歴管理

#### FR-5.1: 履歴の保存

**[Event-driven]**
マンガ画像の生成が完了した場合、システムは以下の情報を履歴として保存すること：
- 入力トピック
- 生成されたタイトル（3-5単語の要約）
- 使用したキャラクター
- 生成画像
- 生成日時

#### FR-5.2: 履歴の一覧表示

**[Ubiquitous]**
システムは、過去の生成履歴を一覧で表示する画面を提供すること。

**[Ubiquitous]**
履歴一覧には、生成日時、サムネイル画像、生成されたタイトルを表示すること。

**[Ubiquitous]**
履歴一覧は生成日時の降順（新しい順）で表示すること。

#### FR-5.3: 履歴の閲覧

**[Event-driven]**
ユーザーが履歴項目をクリックした場合、システムは該当する生成結果の詳細（トピック、キャラクター、生成画像）を表示すること。

#### FR-5.4: 履歴の削除

**[Optional]**
ユーザーが履歴を削除することを選択した場合、システムは確認ダイアログを表示した後、該当する履歴を削除すること。

#### FR-5.5: 無限スクロール

**[Ubiquitous]**
履歴一覧は無限スクロールで追加読み込みすること。

**[Event-driven]**
ユーザーが一覧の下部に到達した場合、システムは次のページの履歴を自動的に読み込むこと。

---

## 非機能要件

### NFR-1: パフォーマンス

**[Ubiquitous]**
システムは、生成処理の進捗更新を 1 秒以内にクライアントへ配信すること。

**[Ubiquitous]**
ページの初期表示は 2 秒以内に完了すること。

**[Ubiquitous]**
履歴一覧の追加読み込みは 1 秒以内に完了すること。

### NFR-2: ユーザビリティ

**[Ubiquitous]**
システムは、モバイルデバイスとデスクトップの両方で適切に表示されるレスポンシブデザインを採用すること。

**[Ubiquitous]**
主要な操作（トピック入力、生成開始、履歴閲覧）は、最大 3 クリック以内で到達可能であること。

**[Ubiquitous]**
システムは、操作中のローディング状態を視覚的に表示すること。

### NFR-3: 信頼性

**[Event-driven]**
バックエンドとの接続が切断された場合、システムは自動的に再接続を試みること。

**[Ubiquitous]**
生成処理中にブラウザを閉じた場合でも、バックエンド側で処理を完了し、履歴に保存すること。

**[Event-driven]**
エラーが発生した場合、システムはユーザーに分かりやすいエラーメッセージを表示すること。

### NFR-4: セキュリティ

**[Ubiquitous]**
アップロードされるファイルのサイズは 10MB 以下に制限すること。

**[Ubiquitous]**
システムは、アップロードされたファイルの内容を検証し、テキストファイル以外を拒否すること。

**[Ubiquitous]**
システムは、アップロードファイルをローカル永続ディスクに保存せず、private な S3 互換オブジェクトストレージで管理すること。

**[Ubiquitous]**
システムは、クライアントから渡された任意 URL を信頼せず、`upload_id` からサーバー側で署名付き URL を解決すること。

**[Ubiquitous]**
システムは、CSRF 対策を実装すること。

**[Ubiquitous]**
システムは、レート制限（10リクエスト/分/IP）を実装すること。

### NFR-5: アクセシビリティ

**[Ubiquitous]**
システムは、キーボードのみでの操作をサポートすること。

**[Ubiquitous]**
システムは、適切な ARIA ラベルを提供すること。
