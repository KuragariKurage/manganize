# プロンプトエンジニアリング解説

このドキュメントは、Manganize におけるプロンプトエンジニアリングの手法と原則を解説します。

## プロンプトの役割

プロンプトは、AI モデルに対する「指示書」です。良いプロンプトは、以下を実現します。

- **明確な意図の伝達**: モデルが何をすべきか理解できる
- **一貫した出力**: 同じような入力に対して安定した結果
- **高品質な生成**: 期待する品質の画像を生成

## Manganize のプロンプト構造

### 全体構造

```
MANGANIZE_AGENT_SYSTEM_PROMPT
├─ Role（役割定義）
├─ Character Reference（キャラクター仕様）
├─ Art Style & Layout（スタイルと構成）
├─ Negative Constraints（禁止事項）
└─ Content / Story（コンテンツ）
```

この構造は、以下の原則に基づいています。

### 1. Role（役割定義）

```
# Role
あなたは「まんがタイムきらら」系列で連載を持っている、萌え系日常4コマ漫画のプロ作家です。
```

**目的**: モデルに具体的なペルソナを与える

**なぜ重要か**:

- **一貫性**: 同じ役割を与えることで、出力スタイルが安定する
- **文脈**: 「プロ作家」という設定が、品質への期待を伝える
- **スタイル**: 「まんがタイムきらら」という具体的なジャンルを指定

**比較**:

```
❌ Bad: "マンガを描いてください"
  → 役割が不明確、どんなマンガかわからない

✅ Good: "あなたは「まんがタイムきらら」系列で連載を持っている、
         萌え系日常4コマ漫画のプロ作家です"
  → 具体的な役割、ジャンル、品質の期待が明確
```

### 2. Character Reference（キャラクター仕様）

```
# Character Reference
添付画像のキャラクターを主役として描いてください。必要に応じて他のキャラクターを表示させることも可能です。
- 名前：くらがりくらげ（愛称：くらげちゃん）
- 外見的特徴（髪型、目の色、服装など）は、添付画像を厳密に参照し、維持すること。
- クールな見た目に反して基本的にポンコツで、かわいらしい表情も見せるところがある。
- かわいらしく（"Moe" style）描画すること。
```

**目的**: キャラクターの一貫性を保つ

**マルチモーダルの活用**:

Gemini は、テキストと画像の両方を入力できるため、以下が可能です。

```python
contents=[
    types.Part.from_text(text=prompt),
    types.Part.from_bytes(data=image_data, mime_type="image/png"),
]
```

画像を添付することで、テキストだけでは伝えにくい詳細（髪型、服装など）を正確に伝達できます。

**キャラクターの性格**:

```
クールな見た目に反して基本的にポンコツで、かわいらしい表情も見せる
```

この記述により、キャラクターの表情や行動に一貫性が生まれます。

**比較**:

```
❌ Bad: "かわいいキャラクターを描いて"
  → 抽象的、解釈の余地が大きい

✅ Good: "添付画像のキャラクターを厳密に参照し、
         外見的特徴を維持すること"
  → 具体的、一貫性が保たれる
```

### 3. Art Style & Layout（スタイルと構成）

```
# Art Style & Layout
- スタイル：「まんがタイムきらら」風のアートスタイル。
    - 特徴：太すぎない柔らかな主線、パステル調または鮮やかな彩色、大きな目、かわいいデフォルメ。
- 構成：縦に並んだ4コマ漫画（4-koma manga）、またはそれを2列並べた形式（最大8コマ）。
- 吹き出し：読みやすい配置にし、セリフは「日本語」で記述すること。
```

**目的**: 視覚的なスタイルと構成を指定する

**具体性の重要性**:

```
❌ Vague: "柔らかい線で描いてください"
  → 「柔らかい」の解釈は人それぞれ

✅ Specific: "太すぎない柔らかな主線"
  → より具体的な指示
```

**色彩の指定**:

```
パステル調または鮮やかな彩色
```

これにより、モデルは「きらら」系特有の色使いを理解します。

**構成の指定**:

```
縦に並んだ4コマ漫画（4-koma manga）、またはそれを2列並べた形式（最大8コマ）
```

レイアウトを明確に指定することで、期待する構図が生成されます。

**言語の指定**:

```
セリフは「日本語」で記述すること
```

これがないと、英語や他の言語で生成される可能性があります。

### 4. Negative Constraints（禁止事項）

```
# Negative Constraints
- 既存の雑誌名やコミックスのロゴ（"Manga Time Kirara"等の文字）を画像内に含めないこと。
- ストーリーの一貫性を保つため、キャラクターの細部（髪飾りや特徴的なパーツ）を勝手に省略・変更しないこと。
```

**目的**: やってほしくないことを明示する

**ネガティブプロンプトの重要性**:

多くの場合、モデルは「やってほしいこと」を実行しますが、「やってほしくないこと」も明示することで、より正確な制御が可能になります。

**具体例**:

```
❌ Without Negative Constraints:
  → モデルが勝手に "Manga Time Kirara" のロゴを追加
  → 髪飾りが省略される

✅ With Negative Constraints:
  → ロゴは含まれない
  → キャラクターの細部が維持される
```

**著作権の考慮**:

```
既存の雑誌名やコミックスのロゴを画像内に含めないこと
```

これにより、著作権侵害のリスクを低減します。

### 5. Content / Story（コンテンツ）

```
# Content / Story
以下のコンテンツを元に、起承転結のあるストーリー構成にしてください：
{content}
```

**目的**: ユーザー入力を構造化して埋め込む

**ストーリー構成の指定**:

```
起承転結のあるストーリー構成
```

これにより、4コマ漫画の基本構造が維持されます。

- **起**: 状況の提示
- **承**: 展開
- **転**: 転換点
- **結**: オチ

**テンプレートの活用**:

```python
MANGANIZE_AGENT_SYSTEM_PROMPT.format(content=user_content)
```

プロンプトをテンプレート化することで、ユーザー入力を動的に埋め込めます。

## プロンプトエンジニアリングの原則

### 1. 具体性（Specificity）

**原則**: 曖昧な表現を避け、具体的に指示する

**例**:

```
❌ Bad: "良い感じに描いて"
  → 「良い感じ」の解釈は無限

✅ Good: "太すぎない柔らかな主線、パステル調の彩色"
  → 具体的な特徴を列挙
```

**コツ**:

- 形容詞を使う場合は、さらに詳細を追加する
- 「〜のような」で具体例を示す
- 数値を使う（「4コマ」「最大8コマ」など）

### 2. 構造化（Structure）

**原則**: プロンプトをセクションごとに整理する

**利点**:

- **可読性**: 人間にとって読みやすい
- **保守性**: セクションごとに編集できる
- **モデルの理解**: モデルも構造を理解しやすい

**例**:

```
✅ Good:
# Role
...

# Character Reference
...

# Art Style & Layout
...
```

### 3. 制約の明示（Constraints）

**原則**: やってほしいことだけでなく、やってほしくないことも記述する

**例**:

```
# Positive Constraints
- キャラクターをかわいく描くこと

# Negative Constraints
- 既存のロゴを含めないこと
- キャラクターの特徴を変更しないこと
```

### 4. 例の提供（Examples）

**原則**: 可能であれば、期待する出力の例を示す

Manganize では、キャラクター画像を添付することで、視覚的な例を提供しています。

```python
types.Part.from_bytes(data=load_kurage_image(), mime_type="image/png")
```

### 5. 反復改善（Iteration）

**原則**: プロンプトは一度で完璧にならない。実験と改善を繰り返す

**プロセス**:

```
1. 初期プロンプトを作成
   ↓
2. 画像を生成して結果を確認
   ↓
3. 問題点を特定（ロゴが入る、キャラが変わる、など）
   ↓
4. プロンプトを修正（ネガティブ制約を追加、など）
   ↓
5. 再度生成して確認
   ↓
（繰り返し）
```

**Manganize の進化**:

```
Version 1:
"マンガを描いてください"
  → 問題: スタイルが不安定、キャラが一貫しない

Version 2:
"4コママンガを描いてください。キャラクターはかわいく。"
  → 改善: 構成が安定
  → 問題: スタイルがまだ不安定

Version 3（現在）:
構造化されたプロンプト（Role, Character, Style, Constraints）
  → 改善: スタイルとキャラが安定、品質が向上
```

## プロンプトのデバッグ

### 問題 1: 生成される画像のスタイルが期待と異なる

**原因**: スタイルの指定が不明確

**解決策**:

```diff
- スタイル：漫画風
+ スタイル：「まんがタイムきらら」風のアートスタイル。
+     - 特徴：太すぎない柔らかな主線、パステル調または鮮やかな彩色
```

### 問題 2: キャラクターが一貫しない

**原因**: キャラクター仕様が曖昧、または参照画像の品質が低い

**解決策**:

```diff
- かわいいキャラクターを描いて
+ 添付画像のキャラクターを主役として描いてください。
+ 外見的特徴（髪型、目の色、服装など）は、添付画像を厳密に参照し、維持すること。
```

参照画像も高品質（1024×1024px 以上、シンプルな背景）にします。

### 問題 3: 不要な要素が含まれる

**原因**: ネガティブ制約が不足

**解決策**:

```diff
+ # Negative Constraints
+ - 既存の雑誌名やコミックスのロゴを画像内に含めないこと。
+ - 暴力的・性的な表現を避けること。
```

### 問題 4: セリフが英語になる

**原因**: 言語の指定がない

**解決策**:

```diff
- 吹き出し：読みやすい配置にすること
+ 吹き出し：読みやすい配置にし、セリフは「日本語」で記述すること
```

## プロンプトのバリエーション

### スタイルを変更する

#### 少年漫画風

```python
SHONEN_MANGA_PROMPT = """
# Role
あなたは週刊少年ジャンプで連載を持っている、バトル漫画のプロ作家です。

# Art Style & Layout
- スタイル：週刊少年ジャンプ風のアートスタイル。
    - 特徴：力強い主線、コントラストの強い影、迫力のある構図。
- 構成：見開き2ページの漫画形式（6-8コマ）。
- 効果音：擬音語を積極的に使用すること。
"""
```

#### 青年漫画風

```python
SEINEN_MANGA_PROMPT = """
# Role
あなたはビッグコミックスピリッツで連載を持っている、リアル系漫画のプロ作家です。

# Art Style & Layout
- スタイル：青年漫画のアートスタイル。
    - 特徴：リアルな人物描写、詳細な背景、写実的な表現。
- 構成：自由な構図（4-8コマ）。
"""
```

### 構成を変更する

#### 1ページ漫画

```python
ONE_PAGE_MANGA_PROMPT = """
# Art Style & Layout
- 構成：1ページ漫画。自由なコマ割りで、ストーリーを1ページに収めること。
"""
```

#### 見開き2ページ

```python
TWO_PAGE_MANGA_PROMPT = """
# Art Style & Layout
- 構成：見開き2ページ漫画。左ページと右ページで連続したストーリー。
"""
```

## プロンプトのテスト

### A/B テスト

2 つのプロンプトを比較して、どちらが良い結果を生成するか確認します。

```python
prompts = {
    "A": MANGANIZE_AGENT_SYSTEM_PROMPT_V1,
    "B": MANGANIZE_AGENT_SYSTEM_PROMPT_V2,
}

for version, prompt in prompts.items():
    result = generate_image(prompt, content)
    save_image(result, f"test_{version}.png")
```

### バリエーションテスト

同じプロンプトで複数回生成して、一貫性を確認します。

```python
for i in range(5):
    result = generate_image(MANGANIZE_AGENT_SYSTEM_PROMPT, content)
    save_image(result, f"variation_{i}.png")
```

## まとめ

Manganize のプロンプトエンジニアリングは、以下の原則に基づいています。

1. **具体性**: 曖昧な表現を避け、詳細に指定する
2. **構造化**: セクションごとに整理して可読性を向上
3. **制約の明示**: ポジティブとネガティブの両方を記述
4. **例の提供**: 画像を添付してビジュアルで示す
5. **反復改善**: 実験と改善を繰り返す

良いプロンプトは、一貫性のある高品質な画像生成を実現し、システム全体の価値を高めます。

## 関連ドキュメント

- [プロンプトをカスタマイズする](../how-to/customize-prompt.md) - 実践的なカスタマイズ方法
- [API リファレンス - Prompts](../reference/api.md#prompts) - プロンプト API の仕様
- [設計の意思決定](design-decisions.md) - プロンプト設計の背景

