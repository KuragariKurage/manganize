services:
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      SERVICES: s3
      DEFAULT_REGION: ap-northeast-1
    volumes:
      - localstack-data:/var/lib/localstack

  localstack-init:
    image: amazon/aws-cli:latest
    depends_on:
      localstack:
        condition: service_started
    environment:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: ap-northeast-1
    entrypoint: >
      sh -c "
        until aws --endpoint-url=http://localstack:4566 s3 ls 2>/dev/null; do
          sleep 1
        done
        aws --endpoint-url=http://localstack:4566 s3 mb s3://manganize-uploads
      "

volumes:
  localstack-data:
